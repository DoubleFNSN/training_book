# 1.Mapping, Annotation and QC

## Data Structure

```text
"shared_scripts"        # shared scripts by Lu Lab
"genomes/hg38"          # reference genomes (i.e. genome sequence and annotation)

github                  # my scripts
proj_exRNA
|-- RNAs_fasta          # rerference transcriptomes (fasta and index) 
|-- sample2_name             
`-- sample1_name        
    |-- fastq           # raw data: fastq files
    |-- fastqc          # QC of fastq
    |-- cutadapt        # trimmed fastq
    |-- collapsed       # de-duplicated fastq 
    `-- mapped          # mapped data: SAM/BAM files
```

### **Inputs**

| **File format** | **Information contained in file** | **File description** | **Notes** |
| --- | --- | --- | --- |
| fastq | **reads** | small RNA-seq reads from single-end libraries. | This will be processed from long reads we got. Raw reads are trimmed as single-ended, 50nt clean reads \(see details in the protocol and example\). |
| fasta | **genome/transcriptome sequences** | sequences of the whole human genome or different RNAs \(transcriptome\) |  |
|  gtf / gff | ** genome annotation** | Default genome annotation file is from GENCODE, mirBase, etc.  | Be careful about exon and intron for mRNA/lncRNA,  precursor and mature product for miRNA. |

### **Outputs**

| **File format** | **Information contained in file** | **File description** | **Notes** |
| --- | --- | --- | --- |
| bam | **alignments, i.e. mapped reads** | Produced by mapping reads to transcriptome | We map to transcriptome for a better sensitivity \(see details in protocol and example\). |
| bigWig | **genomic coordinates** | positions of the mapped reads | reads' file which can be viewed in IGV or UCSC Genome Browser |
| bt2 |  **indexed sequences** | Indexed genome/ transcriptome | Different ncRNA types are indexed separately and mapped sequentially.   |

### Software/Scripts 

* bedtools
* fastqc
* cutadapt
* bowtie2

## Protocol

| **Step** | **Input** | **Tool/script** | **Output** | **Notes** |
| :--- | :--- | :--- | :--- | :--- |
| 0.index |  | - |  |  |
| 0.1 gtf -&gt; fasta | \*.gtf +  GRCh38.p12.genome.fa | bedtools | \*.fa |  |
| 0.2 fasta -&gt; index | \*.fa | bowtie2-build | \*.bt2 |  |
| 1.1 fastqc | \*.fastq | fastqc | \*\_fastqc.html | check raw reads' quality |
| 1.2 trim  | \*.fastq | cutadapt | \*.trimmed.fastq | trim low quality ends, keep 50nt, remove 3' adapter |
| 2nd fastqc | \*.trimmed.fastq | fastqc | \*\_fastqc.html | make sure the low quality reads have been removed and/or trimmed |
| 1.3 Remove rRNA | \*.trimmed.fastq + \*.bt2 | bowtie2 | \*.rRNA.bam +  \*.no\_rRNA.fastq | - |
| 1.4. Mapping | \*.no\_rRNA.fastq + \*.bt2 | bowtie2 | \*.miRNA.bam + \*.nomiRNA.fastq --&gt;  \*.piRNA.bam_ _+ \*.no\_piRNA.fastq --&gt; ... --&gt; ... --&gt; | map to different RNAs \(transcriptome\)  step by step |
| 1.5 Merge and convert mapped results | \*.bam |  | \*.bam | merge multiple bam files into one; convert relative positions to genomic coordinates |
| 1.6 Convert and View mapped reads | \*.bam | samtools, IGV genome browser | \*.bigWig | convert bam to bigWig, then view it in genome browser |



## Running Scripts

### Example of a single case

{% tabs %}
{% tab title="Set Parameters" %}
```bash
# genome seuqneces and annotaions
ln -s /BioII/lulab_b/shared/genomes ~/genomes
export hg38=~/genomes/human_hg38/sequence/GRCh38.p12.genome.fa
export gtf=~/genomes/human_hg38/gtf

# raw data (fastq files)
cd ~/proj_exRNA/example/fastq
ln -s /BioII/lulab_b/shared/projects/exRNA/hcc_examples/fastq/*.fastq .

# working space
cd ~/proj_exRNA
```
{% endtab %}

{% tab title="0.Index" %}
```bash
# Produce indexed transcriptome/genome, using miRNA as an example

#############################################################
# Index transcriptome sequences
#############################################################
# 0.1: gtf2fasta - fetch sequeces from gtf annotated positions 
#############################################################

bedtools getfasta -fi $hg38 -bed $gtf/miRNA.gff -fo RNAs_fasta/miRNA.fa \
  > log.0.1 2>err.0.1 &
  
#############################################################
# 0.2: fasta2bt3 - index fasta file for bowtie 
#############################################################

bowtie2-build RNAs_fasta/miRNA.fa RNAs_fasta/miRNA \
  > log.0.2 2>err.0.2 &

```
{% endtab %}

{% tab title="1.1-2 QC & Trim" %}
```bash
#############################################################
# 1.1: fastaqc - repeat fastqc before and after each trim step
#############################################################

fastqc -q -o example/fastqc miRNA.fastq \
  > log.1.1 2>err.1.1 &
#output the QC files to a dir examples/fastqc

#############################################################
# 1.2: trim - cut adaptor + trim long read
#############################################################
for i in `ls example/fastq/*.fastq`  ; do
  cutadapt -u -100 -q 30,30 --trim-n -m 15 \  
    -a AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC -o $i.cutadapt  $i  
    # -u -100    remove last 100nt so that the first 50nt is kept
    # -q 30,30   read quality need to be above 30
    # -m 15      reads less than 15nt are removed
done
```
{% endtab %}

{% tab title="1.3 Clean rRNA reads" %}
```bash
############################################################# 
# 1.3: map to rRNAs and keep the remaining reads for next 
#############################################################
```
{% endtab %}

{% tab title="1.4-5 Mapping" %}
Map
{% endtab %}

{% tab title="1.6 View" %}

{% endtab %}
{% endtabs %}

### [Script of batch job](https://github.com/urluzhi/scripts/blob/master/projects/exRNA/run_example.sh)

## Practice and Homework

Study and practice the followingï¼š[ ](https://youngleebbs.gitbooks.io/bioinformatics-training-program/content/exrna-seq-analysis/1preprocessing-mapping-and-qc.html)

* [Additional Tutorial](../getting-startted.md#learning-materials): 1.preprocessing\_mapping\_QC
* [Teaching PPT](../getting-startted.md#learning-materials): 
  * 0. Introduction to exRNA-seq; 
  * 1. Mapping, Annotation and QC
* [Teaching Video](../getting-startted.md#learning-materials):  
  * Week V - PARTII.1.Mapping etc - Wang
  * Week VI - PARTII. 2. run your job - example 1 bash  



